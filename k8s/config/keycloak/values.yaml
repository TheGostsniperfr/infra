# default values: https://github.com/bitnami/charts/blob/main/bitnami/keycloak/values.yaml

replicaCount: 1

global:
  defaultStorageClass: "longhorn"

image:
  registry: docker.io
  repository: bitnami/keycloak
  tag: 26.2.5-debian-12-r3


production: true

containerPorts:
  http: 8080
  https: 8443
  metrics: 9000

service:
  type: ClusterIP 
  ports:
    http: 8080
    https: 8443

tls:
  enabled: true
  autoGenerated: true

ingress:
  enabled: true
  ingressClassName: "public" 
  hostname: "keycloak.arffornia.com"
  path: "/" 
  pathType: Prefix
  servicePort: "http"
  annotations:
    cert-manager.io/cluster-issuer: default-issuer
    nginx.ingress.kubernetes.io/backend-protocol: "HTTP"
    nginx.ingress.kubernetes.io/ssl-passthrough: "true"

  tls: false # Remove auto tls certificate creation
  extraTls:
    - hosts:
        - keycloak.arffornia.com
      secretName: keycloak-tls

postgresql:
  enabled: false

externalDatabase:
  host: "postgres-cluster.postgres.svc.cluster.local"
  port: 5432
  database: "keycloak"
  user: "keycloak"
  existingSecret: "keycloak-db-secret" 
  existingSecretPasswordKey: "password"
  existingSecretUserKey: "username"

keycloakConfigCli:
  enabled: false

serviceAccount:
  create: true
  name: "keycloak-sa" # For the upcoming vso auth migration

resources:
  requests:
    memory: 1Gi
    cpu: "1"
  limits:
    memory: 2Gi

# Ref all env vars: https://www.keycloak.org/server/all-config 

extraEnvVars:
  - name: KC_BOOTSTRAP_ADMIN_USERNAME
    valueFrom:
      secretKeyRef:
        name: keycloak-admin-secret
        key: username
  - name: KC_BOOTSTRAP_ADMIN_PASSWORD
    valueFrom:
      secretKeyRef:
        name: keycloak-admin-secret
        key: password

  - name: KC_HOSTNAME
    value: "keycloak.arffornia.com"
  - name: KC_HOSTNAME_URL
    value: "https://keycloak.arffornia.com"
  - name: KC_HOSTNAME_ADMIN_URL
    value: "https://keycloak.arffornia.com"
  - name: KC_PROXY
    value: "edge"
  - name: KC_HTTP_ENABLED
    value: "true"
  - name: KC_HOSTNAME_STRICT_HTTPS
    value: "false"
  
  - name: KC_DB_URL_HOST
    value: "postgres-cluster.postgres.svc.cluster.local"
  - name: KC_DB_URL_PORT
    value: "5432"
  - name: KC_DB_URL_DATABASE
    value: "keycloak"
  - name: KC_DB_USERNAME
    valueFrom:
      secretKeyRef:
        name: keycloak-db-secret
        key: username 
  - name: KC_DB_PASSWORD
    valueFrom:
      secretKeyRef:
        name: keycloak-db-secret
        key: password

  - name: KC_LOG_LEVEL
    value: "DEBUG"
